#include <stdio.h>
#include <math.h>
#include <stdbool.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>
#include <assert.h>
#include <string.h>

#include "many_core.h"
//#include "2by2sim.h"
#include "cpu.h"


//dynamic code array (starts as copy of original code)
int *runtime_code;
//cpu status array
int *cpu_status;
//used to keep track of node numbers
int list_index;
//This is the number of dead nodes (0 destinations) that were removed (needed for node_dest allignment
int nodes_removed;
//the list of all tasks (that have more than 0 destinations)
struct AGP_node *program_APG_node_list;
//main mutex
pthread_mutex_t buss_lock;
//buss master in
struct FIFO *buss_Min;
//buss master out
struct FIFO *buss_Mout;

struct FIFO **buss;

pthread_t *thread_id;

int NUM_CPU;
//FOR OUTPUT DISPLAY
int MESSAGE;
int GRAPH;
struct data_entry **data;
clock_t BEGIN;

//DO NOT REMOVE THE LINE BELLOW!! File may become corrupt if it is (used to write code array in)
//CODE BEGINE//
const int code[] = {//End main:
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x184,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x17c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x174,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x16c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x164,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x15c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x154,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x14c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x144,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x13c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x134,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x12c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x124,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x11c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x114,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x10c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x104,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0xfc,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0xf4,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0xec,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0xe4,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0xdc,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0xd4,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0xcc,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0xc4,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0xbc,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0xb4,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0xac,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0xa4,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x9c,
0x7fffffff,
0x0,
0x1,
0x20,
0xc,
0x0,
0x1,
0x94,
0x7fffffff,
0x0,
0x2,
0x20,
0xc,
0x0,
0x1,
0x8c,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x2a4,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x2a0,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x280,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x27c,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x25c,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x258,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x238,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x234,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x214,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x210,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x1f0,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x1ec,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x1cc,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x1c8,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x1a8,
0xffffffff,
0x7fffffff,
0x1,
0xfffffffc,
0x28,
0xc,
0x1,
0x0,
0x2,
0x1a4,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x2,
0xfffffffc,
0x24,
0xd,
0x2,
0x0,
0x0,
0x0,
0x7fffffff,
0x20,
0xfffffffc,
0x1a0,
0x0,
0x20,
0x0,
0x11a8,
0x0,
0x11d4,
0x0,
0x1200,
0x0,
0x122c,
0x0,
0x1258,
0x0,
0x1284,
0x0,
0x12b0,
0x0,
0x12dc,
0x0,
0x1308,
0x0,
0x1334,
0x0,
0x1360,
0x0,
0x138c,
0x0,
0x13b8,
0x0,
0x13e4,
0x0,
0x1410,
0x0,
0x143c,
0x0,
0x1468,
0x0,
0x1494,
0x0,
0x14c0,
0x0,
0x14ec,
0x0,
0x1518,
0x0,
0x1544,
0x0,
0x1570,
0x0,
0x159c,
0x0,
0x15c8,
0x0,
0x15f4,
0x0,
0x1620,
0x0,
0x164c,
0x0,
0x1678,
0x0,
0x16a4,
0x0,
0x16d0,
0x0,
0x16fc,
0x10,
0x0,
0x2cc,
0xf24,
0x2f4,
0xf4c,
0x31c,
0xf74,
0x344,
0xf9c,
0x36c,
0xfc4,
0x394,
0xfec,
0x3bc,
0x1014,
0x3e4,
0x103c,
0x40c,
0x1064,
0x434,
0x108c,
0x45c,
0x10b4,
0x484,
0x10dc,
0x4ac,
0x1104,
0x4d4,
0x112c,
0x4fc,
0x1154,
0x524,
0x117c,
//Start main @(1472):
//End mtrx_multiply:
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xd04,
0xda4,
0xe44,
0xee4,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xcdc,
0xd7c,
0xe1c,
0xebc,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xcb4,
0xd54,
0xdf4,
0xe94,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xc8c,
0xd2c,
0xdcc,
0xe6c,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xa84,
0xb24,
0xbc4,
0xc64,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xa5c,
0xafc,
0xb9c,
0xc3c,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xa34,
0xad4,
0xb74,
0xc14,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0xa0c,
0xaac,
0xb4c,
0xbec,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x804,
0x8a4,
0x944,
0x9e4,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x7dc,
0x87c,
0x91c,
0x9bc,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x7b4,
0x854,
0x8f4,
0x994,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x78c,
0x82c,
0x8cc,
0x96c,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x584,
0x624,
0x6c4,
0x764,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x55c,
0x5fc,
0x69c,
0x73c,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x534,
0x5d4,
0x674,
0x714,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x50c,
0x5ac,
0x64c,
0x6ec,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x760,
0x9e0,
0xc60,
0xee0,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x6c0,
0x940,
0xbc0,
0xe40,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x620,
0x8a0,
0xb20,
0xda0,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x580,
0x800,
0xa80,
0xd00,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x738,
0x9b8,
0xc38,
0xeb8,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x698,
0x918,
0xb98,
0xe18,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x5f8,
0x878,
0xaf8,
0xd78,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x558,
0x7d8,
0xa58,
0xcd8,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x710,
0x990,
0xc10,
0xe90,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x670,
0x8f0,
0xb70,
0xdf0,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x5d0,
0x850,
0xad0,
0xd50,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x530,
0x7b0,
0xa30,
0xcb0,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x6e8,
0x968,
0xbe8,
0xe68,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x648,
0x8c8,
0xb48,
0xdc8,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x5a8,
0x828,
0xaa8,
0xd28,
0x7fffffff,
0x0,
0xfffffffc,
0x2c,
0x1,
0x0,
0x4,
0x508,
0x788,
0xa08,
0xc88,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffffffff,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x4e4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x4e0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x4bc,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x4b8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x494,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x490,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x46c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x468,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x444,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x440,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x41c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x418,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x3f4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x3f0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x3cc,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x3c8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x3a4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x3a0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x37c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x378,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x354,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x350,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x32c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x328,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x304,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x300,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x2dc,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x2d8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x2b4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x2b0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x28c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x288,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x264,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x260,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x23c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x238,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x214,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x210,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x1ec,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x1e8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x1c4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x1c0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x19c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x198,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x174,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x170,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x14c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x148,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x124,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x120,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0xfc,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0xf8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0xd4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0xd0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0xac,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0xa8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x84,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x80,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x5c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x58,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x34,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x30,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0xc,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x4,
0x2,
0x0,
0x0,
0x1,
0x8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1164,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1160,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x113c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1138,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1114,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1110,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x10ec,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x10e8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x10c4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x10c0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x109c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1098,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1074,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1070,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x104c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1048,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1024,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0x1020,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xffc,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xff8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xfd4,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xfd0,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xfac,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xfa8,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf84,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf80,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf5c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf58,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf34,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf30,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf0c,
0x7fffffff,
0x2,
0xfffffffc,
0x28,
0x3,
0x2,
0x0,
0x0,
0x1,
0xf08
//Start mtrx_multiply @(0):
};
int code_size = 2064;
int main_addr = 1472;
int main_num_nodes = 57;
int dictionary[][3] = {{1472,592,57},
{0,1472,144}
};
int num_dict_entries = 2;
//CODE END//
//DO NOT REMOVE THE LINE ABOVE!!//

/**
 * @brief size function
 *
 * This function is called to calculate the size of each node. (how many entries does the node have)
 * @param [in] addr is the beggining of the node.
 * @param [out] size of the node.
 * @return int
 **/
 int size(int addr){
 	//find size
 	int i = addr + 1;
 	int size = 1;
 	while(code[i] != NODE_BEGIN_FLAG && i < code_size){
 		size++;
 		i++;
 	}
 	return size;
 }

int main(int argc, char **argv)
{
    printf("\n***SIMULATION START***\n\n");
		NUM_CPU;
		MESSAGE = 0;
		GRAPH=0;
		int KG=0;
		int h=0;
		int n = 0;
		int NODE_NUM_MAX = 2;

		int opt;
		while ((opt = getopt(argc, argv, "mhngK:")) != -1) {
             switch (opt) {
             case 'm':
                 MESSAGE = 1;
                 break;
						 case 'h':
 								 h=1;
 								 break;
						 case 'n':
						 		 n = 1;
								 break;
						 case 'g':
						 		 GRAPH = 1;
								 break;
             default: /* '?' */
                 printf("Usage: %s [-m] [-g] [-h] [-n] num_cpu\n",argv[0]);
                 exit(EXIT_FAILURE);
             }
    }
		if(h==1){
			printf("Usage: ./sim [-m] [-n] [-g] [-h] num_cpu  (ex: ./sim 4 or ./sim -m 4)\n[-m]: Display all core messages\n[-n]: Display node details\n[-g]: Create graphs and save them to pdf (Requires gnuplot)\n[-h]: Display all options\n\n");
			return 0;
		}
		if (optind >= argc) {
             fprintf(stderr, "Expected argument!\nhint: add -h to see all options\n\n");
             exit(EXIT_FAILURE);
  	}else{
			NUM_CPU = atoi(argv[optind]);
		}

    if(NUM_CPU < 1){
			printf("NUM CPU %d\n",NUM_CPU);
			printf("YOU MUST HAVE AT LEAST 1 CPU\n");
			return 1;
    }
    double sq = sqrt(NUM_CPU);
    if(sq != (int)sq){
      printf("There must be NxN cores defined.\nex: 1,4,9,16\n");
      return 0;
    }

    //create array of thread id
    thread_id = (pthread_t *) malloc(NUM_CPU*sizeof(pthread_t));

    buss = (struct FIFO**) malloc(NUM_CPU*sizeof(struct FIFO*));
    for(int i = 0; i<NUM_CPU;i++){
      buss[i] = create_FIFO();
    }

		//create cpu struct
    struct CPU_SA *cpus[NUM_CPU];
    for(int i = 0; i<NUM_CPU; i++){
        struct CPU_SA *cpu_t = (struct CPU_SA*) malloc(sizeof(struct CPU_SA));
        cpu_t->cpu_num = i+1;
				cpu_t->main_addr = main_addr;
				cpu_t->num_dict_entries = num_dict_entries;
        cpu_t->PM = (int *) malloc(ADDRASABLE_SPACE*sizeof(int));
				cpu_t->dictionary = dictionary;
        cpu_t->num_cpu = NUM_CPU;
				cpu_t->code_size = 0;
        cpu_t->routing_table = set_up_routing_table(i+1,buss);
        cpus[i] = cpu_t;
    }

		/**********************************************************************************************************/
		int num_nodes_to_make = 0;
		for(int i = 0; i<num_dict_entries; i++){
				num_nodes_to_make += dictionary[i][2];
		}

		//using random coloruing for all nodes (including those in subgraph)
		srand(time(NULL)); //resetting the seed to avoid same result.
		printf("total number of nodes: %d\n", num_nodes_to_make);
		int colouring_random[num_nodes_to_make];//holds node allocations to cpus.
		int counter = 0;
		for(int i = 0; i< num_nodes_to_make; i++){
				colouring_random[i] = rand() % NUM_CPU; //random allocation
				printf("cpu rand[%d]: %d\n", i, colouring_random[i]+1);
				counter++;
		}



		//printf("counter: %d\n", counter);

		int i = 0;
		int node_counter = 0;
		int add;
		int j;
		int rand_cpu;
		int s,si;

    int func_offset = dictionary[0][0];
    int dict_ent = 0;
		//num_nodes_to_make--;
    while(num_nodes_to_make != 0){
      rand_cpu = colouring_random[node_counter];
      j = cpus[rand_cpu]->code_size;
      s = j+4;
      cpus[rand_cpu]->PM[j] = code[i]; //this is the new node flag
			cpus[rand_cpu]->PM[j+1] = code_size - i; //this is the MM offset
			j+=2;i++;
      add = i+5;
      for(i; i<add; i++){
        cpus[rand_cpu]->PM[j] = code[i];
				j++;
      }
      if(code[i-2]==code_expansion){
        add = i + (code[i-1]*2);
        int suggraph_offset = code[i+(code[i-1]*2)+1];
        for(i; i<add; i+=2){
          cpus[rand_cpu]->PM[j] = code[i];
          cpus[rand_cpu]->PM[j+1] = code[i+1];
          cpus[rand_cpu]->PM[j+2] = colouring_random[find_cpu_num(suggraph_offset,code[i+1])]+1;
  				j+=3;
        }
        add = i + (code[i]*3);
        cpus[rand_cpu]->PM[j] = code[i];
        i++;j++;
        for(i; i<add; i+=3){
          cpus[rand_cpu]->PM[j] = code[i];
          cpus[rand_cpu]->PM[j+1] = code[i+1];
          cpus[rand_cpu]->PM[j+2] = colouring_random[find_cpu_num(func_offset,code[i+1])]+1;
          cpus[rand_cpu]->PM[j+3] = code[i+2];
          cpus[rand_cpu]->PM[j+4] = colouring_random[find_cpu_num(suggraph_offset,code[i+2])]+1;
  				j+=5;
        }
      }else{
        add = i + code[i-1] + 1;
        for(i; i<add; i++){
          cpus[rand_cpu]->PM[j] = code[i];
  				j++;
        }
        add = i + code[i-1];
        for(i; i<add; i++){
          cpus[rand_cpu]->PM[j] = code[i];
          cpus[rand_cpu]->PM[j+1] = colouring_random[find_cpu_num(func_offset,code[i])]+1;
  				j+=2;
        }
      }
      cpus[rand_cpu]->PM[s] = j - cpus[rand_cpu]->code_size;
      cpus[rand_cpu]->code_size += cpus[rand_cpu]->PM[s]+1; //+1 for 1 extra entry and +1 to be one cell past
      cpus[rand_cpu]->PM[j] = func_offset; //this is the function offset this node is placed at node_size-1
      if(i == (code_size-func_offset) && i>0){
        dict_ent++;
        func_offset = dictionary[dict_ent][0];
      }
      node_counter++;
			num_nodes_to_make--;
    }

		/**********************************************************************************************************/

    pthread_mutex_init(&buss_lock, NULL);

		if(MESSAGE == 1)
    	printf("\n\nLAUNCHING THREADS!!!\n\n");


		BEGIN = clock();

    for(int i = 0; i<NUM_CPU; i++){
				pthread_create(&thread_id[i], NULL, &CPU_SA_start, cpus[i]);
    }//*/

    /***********************/
    /**** Simulation end ***/
    /***********************/

		//this should prob be in but it causes a seg fault
    for(int i = 0; i<NUM_CPU; i++){
				//pthread_cancel(thread_id[i]); //cancel all threads
				pthread_join(thread_id[i], NULL); //wait for all threads to clean and cancel safely
    }

		printf("\n***SIMULATION COMPLETE***\n\n");

		clock_t finish = clock();
		double elapsed = (double)(finish - BEGIN)/CLOCKS_PER_SEC;

    //pthread_mutex_destroy(&mem_lock);

		printf("TIME ELAPSED: %f\n\n", elapsed);

    //printf("%d AGP nodes created\n",list_index-1);

    return 0;
}

struct FIFO **set_up_routing_table(int cpu_num, struct FIFO **rt){
  struct FIFO **r_table = (struct FIFO**) malloc(NUM_CPU*sizeof(struct FIFO*));
  int N = sqrt(NUM_CPU);
  //printf("NxN: %d\n",N);
  int table[N][N];
  int num = 1;
  int x,y;
  int up,down,left,right;
  for(int i=0; i<N; i++){
    for(int j=0; j<N; j++){
      table[i][j] = num;
      if(num == cpu_num){
        x=i;y=j;
      }
      num++;
    }
  }
  if(x-1>-1){up = table[x-1][y];}
  if(x+1<N){down = table[x+1][y];}
  if(y-1>-1){left = table[x][y-1];}
  if(y+1<N){right = table[x][y+1];}
  num = 0;
  for(int i=0; i<N; i++){
    for(int j=0; j<N; j++){
      if(i<x){
        r_table[num] = rt[up-1];
        //printf("Num: %d -> %d\n",num,up-1);
      }
      else if(i>x){
        r_table[num] = rt[down-1];
        //printf("Num: %d -> %d\n",num,down-1);
      }
      else if(j<y){
        r_table[num] = rt[left-1];
        //printf("Num: %d -> %d\n",num,left-1);
      }
      else if(j>y){
        r_table[num] = rt[right-1];
        //printf("Num: %d -> %d\n",num,right-1);
      }
      else{
        r_table[num] = rt[cpu_num-1];
        //printf("Num: %d -> %d\n",num,cpu_num-1);
      }
      num++;
    }
  }
  return r_table;
}

int find_cpu_num(int func_offset, int dest_offset){

  if(dest_offset == -1){return 0;}
  int end = code_size - func_offset - dest_offset/4;
  int count=0;
  int i=1;
  while(i!=end){
    if(code[i]==NODE_BEGIN_FLAG){count++;}
    i++;
  }
  return count;
}

struct FIFO *create_FIFO(){
	struct FIFO *fifo = (struct FIFO*)malloc(sizeof(struct FIFO));
	pthread_mutex_init(&fifo->fifo_lock, NULL);
	fifo->front = fifo->back = NULL;
	fifo->size = 0;
	return fifo;
}

void sendMessageOnBuss(int cpu_num,struct Message *m){
  struct Message *new = (struct Message*)malloc(sizeof(struct Message));
	*new = *m;
  for(int i=0;i<NUM_CPU;i++){
    if(i!=cpu_num-1){
      pthread_mutex_lock(&buss[i]->fifo_lock);
      sendMessage(buss[i],new);
      pthread_mutex_unlock(&buss[i]->fifo_lock);
    }
  }
}
void sendMessage(struct FIFO *fifo, struct Message *m){
	struct Message *new = (struct Message*)malloc(sizeof(struct Message));
	*new = *m;
	if(fifo->back == NULL){
		fifo->front = fifo->back = new;
		fifo->size+=1;
		fifo->message_counter+=1;
	}else{
		fifo->back->next = new;
		fifo->back = fifo->back->next;
		fifo->size+=1;
		fifo->message_counter+=1;
	}
  fifo->bytes_in+=8;
	//printf("message added\n");
}
struct Message *peekMessage(struct FIFO *fifo){
	if(fifo->front == NULL){
		return NULL;
	}
	struct Message *new = (struct Message*)malloc(sizeof(struct Message));
	*new = *fifo->front;
	new->next = NULL;
	return new;
}
void removeMessage(struct FIFO *fifo){
	if(fifo->front == NULL){
		//return NULL;
		printf("NO MESSAGES TO REMOVE");
	}else{
		struct Message *m = fifo->front;
		fifo->front = fifo->front->next;
		m->next = NULL;

		if(fifo->front == NULL)
			fifo->back = NULL;

		fifo->size-=1;
		free(m);
	}
}
struct Message *popMessage(struct FIFO *fifo){
	if(fifo->front == NULL){
		return NULL;
	}else{
    struct Message *new = (struct Message*)malloc(sizeof(struct Message));
  	*new = *fifo->front;
  	new->next = NULL;

  	struct Message *remove = fifo->front;
  	fifo->front = fifo->front->next;
  	remove->next = NULL;
  	free(remove);

  	if(fifo->front == NULL)
  		fifo->back = NULL;

  	fifo->size-=1;
  	return new;
  }

}

int getFifoSize(struct FIFO *fifo){
	return fifo->size;
}
